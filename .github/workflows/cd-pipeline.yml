name: Continuous Deployment to GKE (IRIS API)

# Trigger the workflow on every push to the main branch
on:
  push:
    branches:
      - main

# Define environment variables using GitHub Secrets for security and clean separation
env:
  # GCP Details (from GitHub Secrets)
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_REPO_NAME: ${{ secrets.GAR_REPO_NAME }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_LOCATION: ${{ secrets.GKE_CLUSTER_LOCATION }}
  
  # Application Details
  GAR_LOCATION: us-central1               # <-- IMPORTANT: Verify this matches your AR region
  IMAGE_NAME: iris-api
  K8S_DEPLOYMENT_NAME: iris-api-deployment # <-- Must match the 'name' in k8s/deployment.yaml

jobs:
  build-push-deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 1. Authenticate to Google Cloud using the Service Account Key Secret
      - id: 'auth'
        name: 'ðŸ”‘ Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}' 

      # 2. Setup gcloud SDK and Docker Configuration
      - name: 'ðŸ› ï¸ Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'ðŸ³ Configure Docker for Artifact Registry'
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # 3. Build and Push Docker Image
      - name: 'ðŸš€ Build, Tag, and Push Image'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "FULL_IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
      # 4. Get GKE Credentials
      - name: 'ðŸ“œ Get GKE credentials'
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}

      # 5. Deploy to Kubernetes
      - name: 'ðŸš¢ Deploy new image version to GKE'
        run: |
          # FIX 1: Apply the DEPLOYMENT manifest first to ensure the object exists.
          # The 'kubectl apply' command handles creation (first run) and updates (subsequent runs).
          kubectl apply -f k8s/deployment.yaml
          
          # FIX 2: Apply the SERVICE manifest (needed for creation/updates)
          kubectl apply -f k8s/service.yaml
          
          # Step to update the image tag on the existing deployment
          kubectl set image deployment/${{ env.K8S_DEPLOYMENT_NAME }} \
            iris-api-container=${{ env.FULL_IMAGE_URI }}
            
          # Wait for the deployment rollout
          kubectl rollout status deployment/${{ env.K8S_DEPLOYMENT_NAME }} --timeout=5m
